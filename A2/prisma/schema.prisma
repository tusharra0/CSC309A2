datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

generator client {
  provider = "prisma-client-js"
}

enum RoleType {
  regular
  cashier
  manager
  superuser
}

enum TransactionType {
  purchase
  redemption
  adjustment
  event
  transfer
}

enum PromotionType {
  automatic
  onetime
}

model User {
  id                  Int             @id @default(autoincrement())
  utorid              String          @unique
  email               String          @unique
  name                String
  password            String
  role                RoleType        @default(regular)
  verified            Boolean         @default(false)
  suspicious          Boolean         @default(false)
  expiresAt           DateTime
  resetToken          String
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  points              Int             @default(0)
  birthday            DateTime?
  lastLogin           DateTime?
  avatarUrl           String?
  promotions          UserPromotion[]
  transactions        Transaction[] // userâ€™s own transactions
  createdTransactions Transaction[]   @relation("CreatedBy")
}

model Promotion {
  id                   Int                    @id @default(autoincrement())
  name                 String
  type                 PromotionType
  minSpending          Int?
  rate                 Float?
  points               Int?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  assignments          UserPromotion[]
  TransactionPromotion TransactionPromotion[]
}

model UserPromotion {
  id          Int       @id @default(autoincrement())
  user        User      @relation(fields: [userId], references: [id])
  userId      Int
  promotion   Promotion @relation(fields: [promotionId], references: [id])
  promotionId Int
  used        Boolean   @default(false)
  usedAt      DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([userId, promotionId])
}

model Transaction {
  id          Int             @id @default(autoincrement())
  type        TransactionType
  spent       Float
  earned      Int
  remark      String          @default("")
  user        User            @relation(fields: [userId], references: [id])
  userId      Int
  createdBy   User            @relation("CreatedBy", fields: [createdById], references: [id])
  createdById Int
  createdAt   DateTime        @default(now())

  promos TransactionPromotion[]
}

model TransactionPromotion {
  id            Int         @id @default(autoincrement())
  transaction   Transaction @relation(fields: [transactionId], references: [id])
  transactionId Int
  promotion     Promotion   @relation(fields: [promotionId], references: [id])
  promotionId   Int
}
